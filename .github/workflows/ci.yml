# AIMO Analysis Engine CI
# 
# Ensures AIMO Standard v0.1.7 compliance and code quality.
# Submodules are required for Standard artifacts.

name: CI

on:
  push:
    branches: [main, 'feat/**', 'fix/**']
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  AIMO_STANDARD_VERSION: "0.1.7"

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      # Checkout with submodules (required for aimo-standard)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      # Setup Python
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"
      
      # Sync AIMO Standard artifacts
      - name: Sync AIMO Standard v${{ env.AIMO_STANDARD_VERSION }}
        run: |
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }} --json
          echo "AIMO Standard artifacts synced successfully"
      
      # Ruff linting
      - name: Lint with ruff
        run: |
          ruff check . --output-format=github
        continue-on-error: false
      
      # Type checking with mypy (lenient for now)
      - name: Type check with mypy
        run: |
          mypy src --ignore-missing-imports --no-error-summary || echo "::warning::mypy reported issues (non-blocking for now)"
        continue-on-error: true
      
      # Run tests
      # Note: Some legacy tests are excluded until codebase migration is complete
      - name: Run tests
        run: |
          pytest -q --tb=short \
            --ignore=tests/test_rule_classifier.py \
            --ignore=tests/test_llm_gemini_schema_validation.py \
            --ignore=tests/test_budget_priority.py \
            --ignore=tests/test_cli_smoke.py \
            --ignore=tests/test_human_verified_protection.py \
            --ignore=tests/test_idempotency.py \
            --ignore=tests/test_input_manifest_hash.py \
            --ignore=tests/test_llm_rate_limit_policy.py
        env:
          PYTHONPATH: ${{ github.workspace }}/src
  
  e2e-smoke:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"
      
      - name: Sync AIMO Standard
        run: |
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }}
      
      # Minimal E2E test with sample log
      - name: Run E2E smoke test
        run: |
          # Create output directory
          mkdir -p data/output
          
          # Run analysis on sample log (dry-run mode if available, or limited)
          # Note: This may require API keys for full LLM analysis
          # For CI, we test the pipeline without actual LLM calls
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from pathlib import Path
          from db.duckdb_client import DuckDBClient
          from orchestrator import Orchestrator
          
          # Initialize with test DB
          db_path = Path('data/output/ci_test.duckdb')
          work_dir = Path('data/work')
          work_dir.mkdir(parents=True, exist_ok=True)
          db_client = DuckDBClient(str(db_path))
          
          # Create orchestrator
          orch = Orchestrator(db_client, work_base_dir=work_dir, aimo_standard_version='0.1.7')
          
          # Verify Standard adapter is available
          from standard_adapter.resolver import resolve_standard_artifacts
          artifacts = resolve_standard_artifacts('0.1.7')
          print(f'Standard version: {artifacts.standard_version}')
          print(f'Artifacts SHA: {artifacts.artifacts_dir_sha256}')
          
          # Verify taxonomy loads
          from standard_adapter.taxonomy import get_taxonomy_adapter
          taxonomy = get_taxonomy_adapter('0.1.7')
          fs_codes = taxonomy.get_allowed_codes('FS')
          print(f'FS codes available: {len(fs_codes)}')
          
          # Verify bundle generator imports
          from reporting.standard_evidence_bundle_generator import StandardEvidenceBundleGenerator
          generator = StandardEvidenceBundleGenerator('0.1.7')
          print('Evidence Bundle generator initialized')
          
          print('E2E smoke test passed!')
          db_client.close()
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src
      
      # Verify evidence bundle generation (without actual run)
      - name: Verify bundle generator
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from reporting.standard_evidence_bundle_generator import (
              StandardEvidenceBundleGenerator,
              BundleGenerationResult
          )
          
          # Verify imports and initialization
          gen = StandardEvidenceBundleGenerator('0.1.7')
          assert gen.aimo_standard_version == '0.1.7'
          print('Bundle generator verification passed!')
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  standard-compliance:
    name: Standard Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify Standard submodule
        run: |
          # Check submodule exists
          if [ ! -d "third_party/aimo-standard" ]; then
            echo "::error::AIMO Standard submodule not found"
            exit 1
          fi
          
          # Check Standard version
          cd third_party/aimo-standard
          git describe --tags --always
          
          # Verify required schemas exist
          for schema in evidence_pack_manifest shadow-ai-discovery agent-activity; do
            if [ ! -f "schemas/jsonschema/${schema}.schema.json" ]; then
              echo "::error::Missing schema: ${schema}.schema.json"
              exit 1
            fi
          done
          
          echo "Standard submodule verified"
      
      - name: Verify submodule commit matches pinned value
        run: |
          cd third_party/aimo-standard
          ACTUAL_COMMIT=$(git rev-parse HEAD)
          echo "Submodule commit: $ACTUAL_COMMIT"
          
          # Extract pinned commit from pinning.py
          PINNED_COMMIT=$(python -c "
          import sys
          sys.path.insert(0, '../../src')
          from standard_adapter.pinning import PINNED_STANDARD_COMMIT
          print(PINNED_STANDARD_COMMIT)
          ")
          echo "Pinned commit: $PINNED_COMMIT"
          
          if [[ "$ACTUAL_COMMIT" != "$PINNED_COMMIT"* ]]; then
            echo "::error::Submodule commit does not match pinned value!"
            echo "::error::Expected: $PINNED_COMMIT"
            echo "::error::Actual: $ACTUAL_COMMIT"
            echo "::error::This may indicate the tag was mutated. See docs/PLAYBOOK_AIMO_STANDARD_UPGRADE.md"
            exit 1
          fi
          
          echo "Commit verification passed!"
        env:
          PYTHONPATH: ${{ github.workspace }}/src
      
      - name: Verify Standard artifacts sync with pinning
        run: |
          # Sync and verify pinning passes
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }} --json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          
          assert data.get('version') == '0.1.7', 'Version mismatch'
          assert data.get('artifacts_dir_sha256'), 'Missing artifacts SHA'
          
          print(f\"Standard v{data['version']} verified\")
          print(f\"SHA: {data['artifacts_dir_sha256']}\")
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src
      
      - name: Verify resolver pinning check passes
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from standard_adapter.resolver import resolve_standard_artifacts
          from standard_adapter.pinning import get_pinned_info
          
          # This will raise StandardPinningError if pinning fails
          artifacts = resolve_standard_artifacts('0.1.7')
          
          pinned = get_pinned_info()
          print('Pinning verification PASSED')
          print(f'  Version: {pinned[\"version\"]}')
          print(f'  Commit: {pinned[\"commit\"][:12]}...')
          print(f'  SHA: {pinned[\"artifacts_dir_sha256\"][:16]}...')
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src
  
  evidence-validation:
    name: Evidence Bundle Validation
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"
      
      - name: Sync AIMO Standard
        run: |
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }}
        env:
          PYTHONPATH: ${{ github.workspace }}/src
      
      - name: Verify Evidence Bundle generation includes Standard info
        run: |
          python -c "
          import sys
          import json
          import tempfile
          from pathlib import Path
          from datetime import datetime
          from dataclasses import dataclass
          
          sys.path.insert(0, 'src')
          
          from reporting.standard_evidence_bundle_generator import StandardEvidenceBundleGenerator
          from standard_adapter.pinning import PINNED_STANDARD_VERSION, PINNED_STANDARD_COMMIT, PINNED_ARTIFACTS_DIR_SHA256
          
          @dataclass
          class MockRunContext:
              run_id: str = 'ci_test_run'
              run_key: str = 'ci_test_key'
              started_at: datetime = None
              status: str = 'running'
              input_manifest_hash: str = 'ci_input_hash'
              signature_version: str = '1.0'
              rule_version: str = '1'
              prompt_version: str = '1'
              work_dir: Path = None
              standard_info: object = None
              
              def __post_init__(self):
                  if self.started_at is None:
                      self.started_at = datetime.utcnow()
          
          # Create test context
          with tempfile.TemporaryDirectory() as tmpdir:
              ctx = MockRunContext(work_dir=Path(tmpdir))
              
              # Generate bundle (without DB data)
              gen = StandardEvidenceBundleGenerator(PINNED_STANDARD_VERSION)
              
              # Create minimal bundle structure
              bundle_dir = Path(tmpdir) / 'evidence_bundle'
              bundle_dir.mkdir()
              
              # Generate run_manifest
              manifest_path = gen._generate_run_manifest(bundle_dir, ctx)
              
              # Verify run_manifest contains Standard info
              with open(manifest_path, 'r') as f:
                  manifest = json.load(f)
              
              assert 'aimo_standard' in manifest, 'run_manifest missing aimo_standard section'
              std_info = manifest['aimo_standard']
              
              assert std_info['version'] == PINNED_STANDARD_VERSION, f'Version mismatch: {std_info}'
              assert 'commit' in std_info, 'Missing commit in run_manifest'
              assert 'artifacts_dir_sha256' in std_info, 'Missing SHA in run_manifest'
              
              print('Evidence Bundle validation PASSED')
              print(f'  Standard version in manifest: {std_info[\"version\"]}')
              print(f'  Commit in manifest: {std_info.get(\"commit\", \"N/A\")[:12]}...')
              print(f'  SHA in manifest: {std_info.get(\"artifacts_dir_sha256\", \"N/A\")[:16]}...')
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src
