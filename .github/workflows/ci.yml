# AIMO Analysis Engine CI
# 
# Ensures AIMO Standard v0.1.7 compliance and code quality.
# Submodules are required for Standard artifacts.

name: CI

on:
  push:
    branches: [main, 'feat/**', 'fix/**']
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  AIMO_STANDARD_VERSION: "0.1.7"

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      # Checkout with submodules (required for aimo-standard)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      # Setup Python
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"
      
      # Sync AIMO Standard artifacts
      - name: Sync AIMO Standard v${{ env.AIMO_STANDARD_VERSION }}
        run: |
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }} --json
          echo "AIMO Standard artifacts synced successfully"
      
      # Ruff linting
      - name: Lint with ruff
        run: |
          ruff check . --output-format=github
        continue-on-error: false
      
      # Type checking with mypy (lenient for now)
      - name: Type check with mypy
        run: |
          mypy src --ignore-missing-imports --no-error-summary || echo "::warning::mypy reported issues (non-blocking for now)"
        continue-on-error: true
      
      # Run tests
      - name: Run tests
        run: |
          pytest -q --tb=short
        env:
          PYTHONPATH: ${{ github.workspace }}/src
  
  e2e-smoke:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"
      
      - name: Sync AIMO Standard
        run: |
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }}
      
      # Minimal E2E test with sample log
      - name: Run E2E smoke test
        run: |
          # Create output directory
          mkdir -p data/output
          
          # Run analysis on sample log (dry-run mode if available, or limited)
          # Note: This may require API keys for full LLM analysis
          # For CI, we test the pipeline without actual LLM calls
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from pathlib import Path
          from db.duckdb_client import DuckDBClient
          from orchestrator import Orchestrator
          
          # Initialize with test DB
          db_path = Path('data/output/ci_test.duckdb')
          db_client = DuckDBClient(str(db_path))
          
          # Create orchestrator
          orch = Orchestrator(db_client, aimo_standard_version='0.1.7')
          
          # Verify Standard adapter is available
          from standard_adapter.resolver import resolve_standard_artifacts
          artifacts = resolve_standard_artifacts('0.1.7')
          print(f'Standard version: {artifacts.standard_version}')
          print(f'Artifacts SHA: {artifacts.artifacts_dir_sha256}')
          
          # Verify taxonomy loads
          from standard_adapter.taxonomy import get_taxonomy_adapter
          taxonomy = get_taxonomy_adapter('0.1.7')
          fs_codes = taxonomy.get_allowed_codes('FS')
          print(f'FS codes available: {len(fs_codes)}')
          
          # Verify bundle generator imports
          from reporting.standard_evidence_bundle_generator import StandardEvidenceBundleGenerator
          generator = StandardEvidenceBundleGenerator('0.1.7')
          print('Evidence Bundle generator initialized')
          
          print('E2E smoke test passed!')
          db_client.close()
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src
      
      # Verify evidence bundle generation (without actual run)
      - name: Verify bundle generator
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from reporting.standard_evidence_bundle_generator import (
              StandardEvidenceBundleGenerator,
              BundleGenerationResult
          )
          
          # Verify imports and initialization
          gen = StandardEvidenceBundleGenerator('0.1.7')
          assert gen.aimo_standard_version == '0.1.7'
          print('Bundle generator verification passed!')
          "
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  standard-compliance:
    name: Standard Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify Standard submodule
        run: |
          # Check submodule exists
          if [ ! -d "third_party/aimo-standard" ]; then
            echo "::error::AIMO Standard submodule not found"
            exit 1
          fi
          
          # Check Standard version
          cd third_party/aimo-standard
          git describe --tags --always
          
          # Verify required schemas exist
          for schema in evidence_pack_manifest shadow-ai-discovery agent-activity; do
            if [ ! -f "schemas/jsonschema/${schema}.schema.json" ]; then
              echo "::error::Missing schema: ${schema}.schema.json"
              exit 1
            fi
          done
          
          echo "Standard submodule verified"
      
      - name: Verify Standard artifacts sync
        run: |
          python scripts/sync_aimo_standard.py --version ${{ env.AIMO_STANDARD_VERSION }} --json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          
          assert data.get('version') == '0.1.7', 'Version mismatch'
          assert data.get('artifacts_dir_sha256'), 'Missing artifacts SHA'
          
          print(f\"Standard v{data['version']} verified\")
          print(f\"SHA: {data['artifacts_dir_sha256']}\")
          "
