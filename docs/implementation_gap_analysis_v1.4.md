# AIMO Analysis Engine - 実装状況と仕様書v1.4の差分分析

**作成日**: 2026-01-17  
**基準**: AIMO_Detail.md (v1.4)  
**目的**: 現在の実装状況と仕様書v1.4の差分を分析し、今後の実装優先順位を明確化

---

## 📊 実装状況サマリ

### ✅ 実装完了（Phase 0-13の大部分）

| 項目 | 実装状況 | 備考 |
|------|---------|------|
| **URL正規化** | ✅ 完了 | 決定性保証、PII検知含む |
| **署名生成** | ✅ 完了 | signature_version管理、決定性保証 |
| **A/B/C検出** | ✅ 完了 | 累積・バースト・サンプリング実装済み |
| **ルール分類** | ✅ 完了 | base_rules.json駆動 |
| **LLM分析** | ✅ 完了 | JSON Schema検証、再試行、Writer Queue |
| **DuckDBスキーマ** | ✅ 完了 | 全テーブル定義済み |
| **Writer Queue** | ✅ 完了 | 単一Writer保証 |
| **冪等性** | ✅ 完了 | run_id決定性、UPSERT実装 |
| **ファイルロック** | ✅ 完了 | 排他制御実装済み |
| **Orchestrator** | ✅ 完了 | チェックポイント再開実装済み |
| **Parquet Hiveパーティション** | ✅ 完了 | 増分処理の基盤 |
| **Excel生成** | ✅ 完了 | constant_memory実装済み |
| **サニタイズCSV** | ✅ 完了 | 外部共有用 |
| **Box同期安定化** | ✅ 完了 | 原子性保証 |
| **Token Bucket予算制御** | ✅ 完了 | A/B優先制御 |

---

## ⚠️ 部分実装・改善が必要な項目

### P0（最優先・必須）

#### 1. 監査説明セクションの完全性（11.3）

**現状**: ほぼ完全実装済みだが、一部改善の余地あり

**実装済み**:
- ✅ A/B/C件数・割合・bytes帯
- ✅ サンプル率・方式・seed
- ✅ LLM利用範囲・PII送信禁止の説明
- ✅ 対象母集団（全量メタ集計）と抽出件数・割合（narrative_textに含まれる）
- ✅ 小容量をゼロ除外していない説明（Small Volume Zero Exclusion Proofセクションで数値証明）

**改善が必要な項目**:
- ⚠️ **除外条件と除外件数** - 実装済みだが、除外件数の正確な集計が不足（一部でN/Aと表示される）
  - Parquetファイルから除外件数を正確に集計する必要がある
  - 現状は「N/A (applied during ingestion)」と表示される場合がある

**仕様書参照**: 11.3

**優先度**: **P0（監査耐性の根幹）** - ただし、除外件数の正確な集計のみ改善が必要

---

#### 2. Excel主要集計の完全性（11.2）

**現状**: ほぼ完全実装済みだが、一部改善の余地あり

**実装済み**:
- ✅ Top 10 Shadow AI Apps（ユーザー数、アクセス数、bytes_sent合計、リスク別内訳）
- ✅ Top 10 High Risk Users（アップロード量、High/Critical宛先数、burst回数）
- ✅ ブロック/許可のポリシー差分が疑われる宛先一覧（PolicyGaps）
- ✅ 部門別リスクスコア（ユーザー数で正規化、High/Critical割合） - `_create_department_risk_sheet`で実装済み
- ✅ 時系列（週次）：Unknown率、AIカテゴリ率、High/Critical比率、ブロック率 - `_create_time_series_sheet`で実装済み

**改善が必要な項目**:
- ⚠️ **時系列（月次集計）** - 週次集計は実装済みだが、月次集計が不足
  - 仕様書では「週次/月次」とあるが、現状は週次のみ
  - 月次集計の追加が必要

**仕様書参照**: 11.2

**優先度**: **P0（監査レポートの完全性）** - ただし、月次集計の追加のみ改善が必要

---

### P1（重要・次フェーズ）

#### 3. パフォーマンスメトリクスの完全性（16.2）

**現状**: 基本実装済みだが、一部メトリクスが不足

**実装済み**:
- ✅ stageごとの処理時間（duration_ms）
- ✅ rows/sec（スループット）
- ✅ I/O量（bytes_read, bytes_written） - オプション実装

**不足項目**:
- ⚠️ **メモリ使用量（可能なら）** - 未実装
  - `psutil` を使用したメモリ使用量の記録が必要
  - `performance_metrics` テーブルに `memory_mb` を記録
- ⚠️ **LLMコスト（推定）と予算消化** - 部分実装
  - `api_costs` テーブルは存在し、コスト推定は実装済み
  - 予算消化率の集計・記録が不足（`performance_metrics` への記録が必要）

**仕様書参照**: 16.2

**優先度**: **P1（観測性の向上）**

---

#### 4. ログの完全性（16.1）

**現状**: 基本実装済みだが、JSONL形式の構造化ログが不足

**実装済み**:
- ✅ 標準出力へのログ出力
- ✅ 実行ログの記録

**不足項目**:
- ⚠️ **JSONL形式の構造化ログ** - 未実装
  - `logs/` ディレクトリへのJSONL出力が必要
  - 必須項目: run開始/終了、入力ファイル、対象件数、A/B/C件数、未知署名数、LLM送信数、失敗数（error_type別）、除外条件と件数

**仕様書参照**: 16.1

**優先度**: **P1（運用監視の向上）**

---

### P2（改善・将来）

#### 5. 増分処理の実装（12.1）

**現状**: Parquet Hiveパーティションは実装済みだが、増分処理ロジックが未実装

**実装済み**:
- ✅ Parquet Hiveパーティション形式（`data/processed/vendor=<v>/date=<YYYY-MM-DD>/...snappy.parquet`）
- ✅ 日付パーティションでの保存

**不足項目**:
- ❌ **既存Parquetとのマージ** - 未実装
  - 翌月以降の増分処理時に、既存Parquetと新規Parquetをマージする機能が必要
  - 日付パーティションでのフィルタリング機能が必要

**仕様書参照**: 12.1, 13.2

**優先度**: **P2（月次BPOの効率化）**

---

#### 6. ML Pre-Filter（12.3）

**現状**: 未実装（オプション機能）

**仕様書参照**: 12.3

**優先度**: **P2（オプション・将来実装）**

---

## 🎯 実装優先順位（詳細）

### Phase 14: 監査説明セクションの完全実装（P0）

**目的**: 監査耐性の完全性を担保（除外件数の正確な集計）

**実装内容**:
1. **除外条件と除外件数の正確な集計**
   - Parquetファイルから除外件数を正確に集計
   - 除外条件ごとの件数を正確に計算
   - Excelの監査説明セクションに正確な件数を表示
   - 現状「N/A (applied during ingestion)」と表示される場合を改善

**注意**: 対象母集団の明示と小容量ゼロ除外の数値証明は既に実装済み

**受け入れ基準**:
- ✅ 除外件数が正確に集計され、Excelレポートに表示される
- ✅ 「N/A」表示がなくなり、すべての除外条件に正確な件数が表示される
- ✅ 監査説明セクションのテストがパス

**仕様書参照**: 11.3

---

### Phase 15: Excel主要集計の完全実装（P0）

**目的**: 監査レポートの完全性を担保（月次集計の追加）

**実装内容**:
1. **時系列集計の月次集計追加**
   - 週次集計は既に実装済み
   - 月次集計の追加（DATE_TRUNC('month', ...)を使用）
   - 月次集計をExcelシート「TimeSeries」に追加
   - 週次と月次の両方を表示

**注意**: 部門別リスクスコアと週次時系列集計は既に実装済み

**受け入れ基準**:
- ✅ 仕様書11.2の全必須集計がExcelレポートに含まれる
- ✅ 月次集計が正しく計算され、Excelレポートに表示される
- ✅ 週次と月次の両方が利用可能

**仕様書参照**: 11.2

---

### Phase 16: パフォーマンスメトリクスの完全実装（P1）

**目的**: 観測性の向上

**実装内容**:
1. **メモリ使用量の記録**
   - `psutil` を使用したメモリ使用量の取得
   - 各ステージ開始時・終了時のメモリ使用量を記録
   - `performance_metrics` テーブルに `memory_mb` を記録

2. **LLMコストと予算消化の記録**
   - 予算消化率の計算（`api_costs` から集計）
   - `performance_metrics` テーブルに `budget_consumed_pct` を記録
   - 日次予算の消化状況を記録

**受け入れ基準**:
- ✅ 全ステージのメモリ使用量が記録される
- ✅ LLMコストと予算消化率が記録される
- ✅ `performance_metrics` テーブルに保存される

**仕様書参照**: 16.2

---

### Phase 17: JSONL構造化ログの実装（P1）

**目的**: 運用監視の向上

**実装内容**:
1. **JSONLログ出力**
   - `logs/` ディレクトリへのJSONL出力
   - 必須項目の記録: run開始/終了、入力ファイル、対象件数、A/B/C件数、未知署名数、LLM送信数、失敗数（error_type別）、除外条件と件数

2. **ログローテーション**
   - 日次ログファイルの生成
   - 古いログファイルのアーカイブ

**受け入れ基準**:
- ✅ JSONL形式の構造化ログが出力される
- ✅ 仕様書16.1の全必須項目が記録される
- ✅ ログファイルが `logs/` ディレクトリに保存される

**仕様書参照**: 16.1

---

### Phase 18: 増分処理の実装（P2）

**目的**: 月次BPOの効率化

**実装内容**:
1. **既存Parquetとのマージ**
   - 日付パーティションでの既存Parquetの検索
   - 新規Parquetと既存Parquetのマージ
   - 重複排除（run_idベース）

2. **増分処理ロジック**
   - 日付範囲指定での処理
   - 既存データのスキップ
   - 新規データのみの処理

**受け入れ基準**:
- ✅ 既存Parquetと新規Parquetが正しくマージされる
- ✅ 増分処理が正しく動作する
- ✅ 重複が発生しない

**仕様書参照**: 12.1, 13.2

---

## 📋 実装チェックリスト

### P0（最優先・必須）

- [x] **監査説明セクションの完全実装** - Phase 14 ✅ 完了
  - [x] 対象母集団の明示（全量メタ集計、抽出件数・割合） - ✅ 実装済み
  - [x] 小容量ゼロ除外の数値証明 - ✅ 実装済み
  - [x] 除外条件と除外件数の正確な集計（Parquetファイルから正確に集計） - ✅ 実装完了
  - [x] テスト追加 - ✅ 完了

- [x] **Excel主要集計の完全実装** - Phase 15 ✅ 完了
  - [x] 部門別リスクスコアの実装 - ✅ 実装済み
  - [x] 時系列集計（週次）の実装 - ✅ 実装済み
  - [x] 時系列集計（月次）の追加 - ✅ 実装完了
  - [x] テスト追加 - ✅ 完了

### P1（重要・次フェーズ）

- [x] **パフォーマンスメトリクスの完全実装** - Phase 16 ✅ 完了
  - [x] メモリ使用量の記録 - ✅ 実装済み
  - [x] LLMコストと予算消化の記録 - ✅ 実装済み
  - [x] テスト追加 - ✅ 完了

- [x] **JSONL構造化ログの実装** - Phase 17 ✅ 完了
  - [x] JSONLログ出力 - ✅ 実装済み
  - [x] 各ステージでのログ記録 - ✅ 実装完了
  - [x] テスト追加 - ✅ 完了

### P2（改善・将来）

- [ ] **増分処理の実装** - Phase 18
  - [ ] 既存Parquetとのマージ
  - [ ] 増分処理ロジック
  - [ ] テスト追加

---

## 🔄 実装順序の推奨

1. **Phase 14（監査説明セクション）** → 監査耐性の完全性 **P0**
2. **Phase 15（Excel主要集計）** → 監査レポートの完全性 **P0**
3. **Phase 16（パフォーマンスメトリクス）** → 観測性の向上 **P1**
4. **Phase 17（JSONLログ）** → 運用監視の向上 **P1**
5. **Phase 18（増分処理）** → 月次BPOの効率化 **P2**

---

## 📝 注意事項

1. **監査耐性の優先**
   - Phase 14とPhase 15は監査耐性の根幹であるため、最優先で実装
   - 監査説明セクションの完全性は必須

2. **観測性の向上**
   - Phase 16とPhase 17は運用監視に重要だが、監査耐性ほど優先度は高くない
   - ただし、本番運用前に実装を推奨

3. **増分処理の実装**
   - Phase 18は月次BPOの効率化に重要だが、初回運用時は必須ではない
   - 初回運用後に実装を検討

---

## 🎯 成功条件（Definition of Done）

全Phase完了時に以下を満たすこと:

1. ✅ **監査耐性**: 決定性・来歴・抽出設計を説明可能（Phase 14完了）
2. ✅ **完全性**: Excel・JSON・サニタイズCSVの全出力形式が完全（Phase 15完了）
3. ✅ **観測性**: パフォーマンスメトリクスとログが完全（Phase 16-17完了）
4. ✅ **効率性**: 増分処理により月次BPOが効率化（Phase 18完了）

---

**実装完了**: Phase 14-17は全て実装完了（2026-01-17）

詳細は `docs/phase14_17_implementation_summary.md` を参照。

**次ステップ**: Phase 18（増分処理の実装）はP2（将来実装）として残置
